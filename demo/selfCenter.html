<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>个人中心</title>
  <!-- LeanCloud -->
    <script src="../dist/av.js"></script>
	<script src="./js/jquery-3.2.0.min.js"></script>
    <link rel="stylesheet" href=".\css\font-awesome.css">
    <link rel="stylesheet" href="css/aw-sc.css">
</head>
<body>
    <div class="container">
    
            <div class="header clearfix">
                <div class="layout">
                    <a href="index.html" ><span class="title ">
                        <i class="icon-lightbulb"></i>问谁</span></a>
                    <ul class="function">
                        <li><a href="#">我的个人中心</a> </li>
                        <li><a href="register.html" class="log-out">退出登录</a></li>
                    </ul>
                </div>
               
            </div>
            <div class="layout u-content-container">
                <div class="u-banner">
                    <div class="circle-first">
                        <i class="circle-round i-answer">
                            <span class="right">回答数<em>20</em></span>
                        </i>
                    </div>
                    <div class="circle-second">
                        <i class="circle-round i-help">
                            <span class="right">
                                帮助的人<em>1</em>
                            </span>
                        </i>
                        <i class="circle-round i-pop">
                            <span class="left">
                                <em>100</em>点赞数
                            </span>
                        </i>
                    </div>
                    <div class="money">
                        <p>财富值</p>
                        
                    </div>
                    <div class="circle-wp">
                        <div class="pie-container">

                        </div>
                    </div>
                </div>
                <div class="u-img">
                    <img src="./img/1.png">
                </div>
                <div class="u-info">
                    <div class="u-info-name"></div>
                </div>
            </div>
            
            <div class="money-course-container clearfix">
                <div class="layout clearfix">
                    <div class="balance clearfix">
                        <p class="fortune">财富值余额</p>
                       
                        
                    </div>
                    <div class="course">
                        <h5>课程表</h5>
                        <table>
                            <tbody>
                                <tr class="firstLine">
                                <td>星期一</td>
                                <td>星期二</td>
                                <td>星期三</td>
                                <td>星期四</td>
                                <td>星期五</td>
                                </tr>
                                <tr>
                                <td>
                                    <a href="groupDetail.html">
                                    <p class="course">高等数学下</p>
                                    <p class="teacher">童丽珍</p>
                                    </a>
                                </td>
                                <td>
                                    <a href="groupDetail.html">
                                    <p class="course">电子政务与电子商务</p>
                                    <p class="teacher">张新香</p>
                                    </a>
                                </td>
                                <td>
                                    <a href="groupDetail.html">
                                    <p class="course">线性代数</p>
                                    <p class="teacher">卢国祥</p>
                                    </a>
                                </td>
                                <td></td>
                                <td>
                                    <a href="groupDetail.html">
                                    <p class="course">电子政务与电子商务</p>
                                    <p class="teacher">张新香</p>
                                    </a>
                                </td>
                                </tr>
                                <tr>
                                <td>
                                    <a href="groupDetail.html">
                                    <p class="course">线性代数</p>
                                    <p class="teacher">卢国祥</p>
                                    </a>
                                </td>
                                <td>
                                    <a href="groupDetail.html">
                                    <p class="course">法学通论</p>
                                    <p class="teacher">韩桂军</p>
                                    </a>
                                </td>
                                <td></td>
                                <td>
                                    <a href="groupDetail.html">
                                    <p class="course">数据库管理实务</p>
                                    <p class="teacher">王会举</p>
                                    </a>
                                </td>
                                <td>
                                    <a href="groupDetail.html">
                                    <p class="course">体育专项</p>
                                    <p class="teacher">李辉</p>
                                    </a>
                                </td>
                                </tr>
                                <tr>
                                <td>
                                    <a href="groupDetail.html">
                                    <p class="course">实用翻译</p>
                                    <p class="teacher">汪世蓉</p>
                                    </a>
                                </td>
                                <td>
                                    <a href="groupDetail.html">
                                    <p class="course">程序开发与实践</p>
                                    <p class="teacher">余传明</p>
                                    </a>
                                </td>
                                <td>
                                    <a href="groupDetail.html">
                                    <p class="course">计算机网络原理</p>
                                    <p class="teacher">刘琪</p>
                                    </a>
                                </td>
                                <td>
                                    <a href="groupDetail.html">
                                    <p class="course"></p>
                                    <p class="teacher"></p>
                                    </a>
                                </td>
                                <td>
                                    <a href="groupDetail.html">
                                    <p class="course"></p>
                                    <p class="teacher"></p>
                                    </a>
                                </td>
                                </tr>
                                <tr>
                                <td>
                                    <a href="groupDetail.html">
                                    <p class="course">计算机网络原理</p>
                                    <p class="teacher">刘琪</p>
                                    </a>
                                </td>
                                <td><a href="groupDetail.html">
                                    <p class="course"></p>
                                    <p class="teacher"></p>
                                    </a></td>
                                <td><a href="groupDetail.html">
                                    <p class="course"></p>
                                    <p class="teacher"></p>
                                    </a></td>
                                <td><a href="groupDetail.html">
                                    <p class="course"></p>
                                    <p class="teacher"></p>
                                    </a></td>
                                <td><a href="groupDetail.html">
                                    <p class="course">建模语言</p>
                                    <p class="teacher">屈振新</p>
                                    </a></td>
                                </tr>
                                <tr>
                                <td><a href="groupDetail.html">
                                    <p class="course">数据库管理实务</p>
                                    <p class="teacher">王会举</p>
                                    </a></td>
                                <td><a href="groupDetail.html">
                                    <p class="course">文革电影评析</p>
                                    <p class="teacher">李军湘</p>
                                    </a></td>
                                <td><a href="groupDetail.html">
                                    <p class="course">国际大案</p>
                                    <p class="teacher">戴涛</p>
                                    </a></td>
                                <td><a href="groupDetail.html">
                                    <p class="course">文革电影评析</p>
                                    <p class="teacher">李军湘</p>
                                    </a></td>
                                <td><a href="groupDetail.html">
                                    <p class="course"></p>
                                    <p class="teacher"></p>
                                    </a></td>
                                </tr>
                            </tbody>
                            
                            </table>
                    </div>
                </div>
                
            </div>
            
            <div class="questionHistory">
                <div class="layout">
                    <ul class="menu">
                        <li class="menu-tab  active">
                            等我答
                        </li>
                        <li class="menu-tab">
                            我的回答
                        </li>
                     
                        <li class="menu-tab">
                            我的提问
                        </li>
                        <li class="menu-tab" id="fortune">
                            我的财富值历程
                        </li>
                    </ul>
                    <ul class="listWrap">
                        <li class="list wait-answer ask-history  active" id="wait-answer">
                           
                            
                        </li>

                        <li class="list answers-history" id="answers-history">
                        
                        </li>

                        <li class="list ask-history" id="ask-history">
       

                        </li>
                        <li class="list fortuneChange" id="fortuneChange">
                            <ul class="myhistory-list">
                               
                            </ul>

                        </li>

                    </ul>
                    
                </div>
               
            </div>

    </div>

</body>
<script>
    //初始化AV
    const appId = 'YoUKvGrpeG6iQlrkqeTqrgQU-gzGzoHsz';
    const appKey = 'rvYorKtJCDBTL5bmbiINj99c';
    const region = 'cn';
    
    
    AV.init({ appId, appKey, region });

    
    var currentUser = AV.User.current()
   
    if(currentUser){
        var currentUserID = AV.User.current().id
        var user = AV.Object.createWithoutData('_User', currentUserID);
        user.fetch().then(function () {
            console.log(user)
            var realName = user.get('realName');
            $('.u-info-name').text(realName)
            
            //真实姓名的获取是异步的

             //把我的提问取进页面
            var myQuery = new AV.Query('Question')
            myQuery.equalTo('username', realName)
            myQuery.find().then(function(results){
                console.log(results)
                console.log(results.length)
                if(results.length === 0){

                    let tip = $('<p style="padding:30px;"></p>').text('暂无记录，快去提问吧!')
                    $('#ask-history').append(tip)
                }
                results.forEach(function(result){
                    let title = result.get('title')
                    let time = result.get('time')
                    let answerNumber = result.get('answerNumber')
                    let id = result.id

                    let html = `
                        <a href="myQuestionDetail.html?id=${id}" class="list-item">
                            <div class="title-info">
                                ${title}
                            </div>
                            
                            <div class="extra-info">
                                <span class="reply-num">${answerNumber}条回答</span>
                                <span class="time">${time}</span>
                            </div>
                        </a>
                    `

                    $('#ask-history').append(html)

                })

            })


             /*把我的回答取进页面*/
    var myAnswer = new AV.Query('Answer')
    myAnswer.equalTo('authorName', realName)
    myAnswer.find().then(function(results){
        if(results.length === 0){

            let tip = $('<p style="padding:30px;"></p>').text('暂无记录，快去回答问题吧!')
            $('#answers-history').append(tip)
        }

        console.log(results)
        results.forEach(function(result){
           
            let time = result.get('time')
            let thumbUp = result.get('thumbUp')
            let id = result.id
            let content = result.get('content')
            let question = result.get('dependent')
            let questionID = question.id

            let currentQuestion = AV.Object.createWithoutData('Question', questionID)
            currentQuestion.fetch().then(function () {
                var title = currentQuestion.get('title');// 读取 title
                let html = `
                <a href="MyQuestionDetail.html?id=${questionID}" class="list-item">
                    <div class="title">${content}</div>
                    <div class="ask-info">
                        <span>${title}</span>
                    </div>
                    <div class="extra-info">
                        <i class="icon-thumbs-up"></i>
                        <span class="thumb-up-num">${thumbUp}</span>
                        <span class="time">${time}</span>
                    </div>
                </a>

                `
             $('#answers-history').append(html)

               
            }, function (error) {
                // 异常处理
            });

          
           

        })

    })


    /*把我的财富值变化取进页面*/
    var myFortune = new AV.Query('UserInfo')
    myFortune.equalTo('username', realName)
    myFortune.find().then(function(results){
       
        results.forEach(function(result){
           
            let reasonHistory = result.get('reasonHistory')
            
            if(!reasonHistory){
                let tip = $('<p style="padding:30px;"></p>').text('暂无记录，快去回答赢取财富值吧!')
                $('#fortuneChange').append(tip)
            }
           
            let time = result.updatedAt
            
            let changeHistory = result.get('changeHistory')
           
            let goalTime = new Date(time)
          
            let fortune = result.get('fortune')

            goalTime = goalTime.getFullYear() + '-' + (goalTime.getMonth()+1) + '-' + goalTime.getDate()
            
            let changeMoney = `<p class="num">${fortune}</p>`
                 $('.u-banner> .money').append(changeMoney)

                 let changeMoney2 = `
                    <span class="number"><em>${fortune}</em>点</span>
                    <ul class="button clearfix">
                        <li>
                            <a href="" class="button-item topics">充值</a>
                        </li>
                        <li>
                            <a href="" class="button-item topics">兑换奖品</a>
                        </li>
                        <li>
                            <a href="#fortune" class="button-item topics">交易记录</a>
                        </li>
                    </ul>
                    `
                 $('.balance').append(changeMoney2)

            //构造当前回答的相应的问题对象
                var html = ``
                for(let i = 0; i < reasonHistory.length; i++){
                    html += `
                        <li>
                            <p class="time">${goalTime}</p>
                            <p class="things">${reasonHistory[i]}</p>
                            <p class="count-change">
                                <em>财富值</em>
                                <span class="em-txt">${changeHistory[i]}</span>
                            </p>
                        </li>

                        `
                       
                }
           
                
                 $('.myhistory-list').append(html)

                 

        })

    })







    }, function (error) {
        // 异常处理
    });

            

    
        

   }

   //把没有解决的问题取进页面
     var query = new AV.Query('Question');
     query.equalTo('answerNumber', '0')
     query.find().then(function (results) {
        //把结果取出来
        results.forEach(function(result){
            let title = result.get('title')
            let answerNumber = result.get('answerNumber')
            let time = result.get('time')
            let reward = result.get('reward')
            let questionID = result.id
    

            let html = `
                <a href="questionDetail.html?id=${questionID}" class="list-item">
                    <div class="title-info">
                        <h4>${title}<span class="reward"><i class="icon-trophy"></i>悬赏${reward}分</span></h4>                
                    </div>
                    
                    <div class="extra-info">
                        <span class="reply-num">${answerNumber}条回答</span>
                        <span class="time">${time}</span>
                    </div>
                </a>
            `

            $('#wait-answer').append(html)

        })
        }, function (error) {
    });

   

   







    /*切换选项卡*/
    var $menuTabs = $('.menu>li')

    $('.menu').on('click', function(e){
        if($(e.target).hasClass('menu-tab')){
            var index = $(e.target).index()
            $.each($('.menu>li'), function(index, val){
                $(this).removeClass('active')
            })
            $(e.target).addClass('active')
            $(this).parents('.layout').find('.list').removeClass('active')
            $(this).parents('.layout').find('.list').eq(index).addClass('active')
            
        }

    })

    /*退出登录*/
    $('.log-out').on('click', function(e){
        AV.User.logOut()
    })
   
</script>
</html>